---
title: "Trabajo Final RStudio"
author: "Nicole Valverde Montes De Oca"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      number_sections: true
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Conociendo RStudio
### 1.1 Expresiones Regulares

<div style="text-align: justify">

Una expresión regular es una secuencia de caracteres que forma un patrón de búsqueda, principalmente utilizada para la búsqueda de patrones de cadenas de caracteres u operaciones de sustituciones. Es comunmente utilizada en R con muchas finalidades, por lo que es necesario que las domines para un buen uso de RStudio. A continuación se realizará la comparación de dos sitios webs que muestran cómo y para qué sirven:

1. [RPubs - Documento de Yubar Daniel Marín Benjumea](http://rpubs.com/ydmarinb/429756)
2. [RStudio Cheatsheet](https://rstudio.com/wp-content/uploads/2016/09/RegExCheatsheet.pdf)

El documento de *RPubs* comienza con una introducción acerca de las expresiones regulares, la teoría detrás de ellas, y los principales operadores: unión, concatenación y clausura de Kleene. Luego de esto, muestra los diferentes cuantificadores y lo que significan cada vez que están alado de un caracter. Asímismo, explica cada uno de los símbolos que pueden generar una alteración, y los diferentes agrupadores. Además, explica como la barra invertidad se utiliza para escapar el siguiente carácter de la expresión de búsqueda de forma que este adquiera un significado especial o deje de tenerlo. Y para terminar la explicación, presenta los significados del signo de exclamación y de los metacaracteres especiales. Finalmente, hace uso de algunos de los elementos mencionados anteriormente y funciones como `grep` o `str_detect` para ejemplificar el uso de las expresiones regulares.

Por otra parte, considero que en la *cheatsheet de RStudio* se pueden encontrar más símbolos utilizados en las expresiones regulares, además de que explica más y de mejor manera las formas de encontrar coincidencias entre los patrones o cadenas. Esta hoja no cuenta con ejemplos concretos, pero si yo tuviera que decicir con cuál de las dos fuentes quedarme, elegiría la cheatsheet de RStudio.  
<div/>


### 1.2 Markdown

<div style="text-align: justify">
R Markdown provee un marco de referencia para la ciencia de datos, combinando tu código, sus resultados, y tus comentarios en prosa. Los documentos de R Markdown son completamente reproducibles y soportan docenas de formatos de salida tales como PDFs, archivos de Word, presentaciones y más. En este caso, se revisarán las siguientes dos fuentes que brindan información acerca de cómo escribir códigos en RMarkdown:

1. [R Markdown: The Definitive Guide por Yihui Xie, J. J. Allaire, Garrett Grolemund](https://bookdown.org/yihui/rmarkdown/)
2. [R Markdown by RStudio](https://rmarkdown.rstudio.com/lesson-1.html)

El libro de *R Markdown: The Definitive Guide* abarca muchos temas, desde lo más básico de la sintáxis y la explicación del entorno de Markdown, cómo configurar la tabla de contenidos, entre otros, llegando a temas de reportes parametrizados, cómo crear tu propio widget, Shiny, etc. Si es tu primer contacto con el lenguaje de Markdown, esto podría ser muy abrumador, pero si estás dispuesto a revisar todos los temas y realmente aprender, este libro está de maravilla.

Por otra parte, si deseas algo más rápido y fácil de revisar, la explicación de *R Mrkdown de RStudio* es la ideal para ti ya que es más ligera y muestra de forma más visual el entorno. Nótese que también llega a temas avanzados como el libro anterior, pero de una manera en que lo hace más fácil de procesar.

<div/>


## 2. Cambio Climático: un análisis exploratorio

<div style="text-align: justify">

Para nadie es un secreto que, en los últimos años, las condiciones del planeta se han degenerado, y el cambio climático constituye la mayor amenaza medioambiental a la que se enfrenta la humanidad. Según [Greenpeace](https://es.greenpeace.org/es/trabajamos-en/cambio-climatico/), el impacto potencial es enorme, no sólo por las predicciones de falta de agua potable, grandes cambios en las condiciones para la producción de alimentos y un aumento en los índices de mortalidad debido a inundaciones, tormentas, sequías y olas de calor, sino que también conllevaría profundas consecuencias económicas y sociales. Los países más pobres, que están peor preparados para enfrentar cambios rápidos, serían los que sufriróan las peores consecuencias.

En este documento, se analizará la situación medioambiental de las diferentes regiones, tomando como periodo de estudios los años 2007 - 2017 (teniendo en consideración que no todas las variables poseen la data completa en los últimos dos años de estudio). 

Los datos han sido obtenidos mediante *webscrapping* del sitio oficial del [Banco Mundial](https://www.bancomundial.org/).

Variables a analizar:

* Acceso a la electricidad (% de población)
* Emisiones de CO2 (kt)
* Producción de energía eléctrica renovable (% de la producción total de electricidad)

<div/>



### 2.1 Emisiones de CO2 en el mundo

<div style="text-align: justify">

El CO2 es el principal gas de efecto invernadero de larga duración en la atmósfera relacionado con las actividades humanas. La concentración llegó a un nuevo valor máximo en 2018, 407,8 ppm, es decir, un 147% más del nivel preindustrial en 1750. Las *emisiones de dióxido de carbono* son las que provienen de la quema de combustibles fósiles y de la fabricación del cemento. Incluyen el dióxido de carbono producido durante el consumo de combustibles sólidos, líquidos, gaseosos y de la quema de gas.A continuación, se muestra la evolución, por región, de estas emisiones desde el 2007 al 2014.

<div/>

```{r co2, warning = FALSE, message = FALSE, echo=FALSE, fig.width=8}
library(tidyverse)
library(XML)
library(gganimate)
library(reshape2)
library(ggplot2)
library(plyr)
library(dplyr)
library(plotly)
library(viridis)
library(hrbrthemes)
library(knitr)
library(kableExtra)

#Extraccion de data
#INFO GENERAL DE LOS PAISES

wd <- "http://api.worldbank.org/v2/country?per_page=500&page=1"
wd <- readLines(wd)
wd <- xmlParse(wd)


tmp <- xpathSApply(wd,
                   "//*/wb:country", 
                   function(x) xmlApply(x, xmlValue))

tmp <- as.data.frame(tmp)
tmp <- data.frame(t(tmp))

#Limpieza de datos
country.data <- na.omit(tmp)
country.data = country.data[,!(names(country.data) %in% c("iso3c","adminregion", "lendingType", "capitalCity"))]
country.data <- country.data[!(country.data$region=="Aggregates"),]
names(country.data)[1:2] <- c("code", "country")
names(country.data)[4] <- "income.level"

#Ajuste de formato de variables
country.data$code <- as.character(unlist(country.data$code))
country.data$country <- as.character(unlist(country.data$country))
country.data$region <- as.character(unlist(country.data$region))
country.data$income.level <- as.character(unlist(country.data$income.level))
country.data$longitude <- as.numeric(unlist(country.data$longitude))
country.data$latitude <- as.numeric(unlist(country.data$latitude))



#INDICADORES PARA CADA PAIS


wdi <- "https://api.worldbank.org/v2/country/all/indicator/EG.ELC.ACCS.ZS;EN.ATM.CO2E.KT;EG.ELC.RNEW.ZS;SP.POP.TOTL;SH.H2O.BASW.ZS;NY.GDP.PCAP.KD?date=2007:2016&per_page=21000&source=2"
wdi <- readLines(wdi)
wdi <- xmlParse(wdi)


indicators <- xpathSApply(wdi,
                          "//*/wb:data", 
                          function(x) xmlApply(x, xmlValue))


indicators <- as.data.frame(indicators)
indicators <- data.frame(t(indicators)) 

#Limpieza de datos
data = indicators[,!(names(indicators) %in% c("unit","obs_status", "decimal"))]
names(data)[3:4] <- c("code", "year")



#Ajuste de formato de variables
data$code <- as.character(unlist(data$code))
data$country <- as.character(unlist(data$country))
data$indicator <- as.character(unlist(data$indicator))
data$value <- as.numeric(unlist(data$value))
data$year <- as.integer(unlist(data$year))



#MERGE DATA DE PAISES E INDICADORES

dat <- merge(x = country.data, y = data, by.x = "country", by.y= "country")
dat = dat[,!(names(dat) %in% c("code.y"))]
names(dat)[2] <- c("code")
tmp <- grep("Africa", dat$region)
dat[tmp, 'region'] <- 'Africa'
dat<-dat[!(dat$region=="Aggregates"),]


# MELT BASE

datdcasted <- dcast(dat, country + code + region + year + income.level + longitude + latitude ~ indicator, value.var = "value")
names(datdcasted)[8:13] <- c("electricity", "co2", "gdppc", "water", "pop", "renew")


#Bar Animated Plot


datdcastedbarplot <- datdcasted
datdcastedbarplot <- datdcastedbarplot[!(datdcastedbarplot$year == 2015),]
datdcastedbarplot <- datdcastedbarplot[!(datdcastedbarplot$year == 2016),]
datdcastedbarplot$co2rounded <- datdcastedbarplot$co2/1000


plot1 <- ggplot(datdcastedbarplot, aes(x=region, y=co2rounded, fill=region)) + 
  geom_bar(stat='identity') + transition_time(year) +
  theme_classic() + ease_aes('sine-in-out')  + 
  labs(x='', y = 'CO2 emissions (kt)', title = 'CO2 Emissions by Region', subtitle = 'Year: {frame_time}', caption = 'Source: World Bank') + 
  theme(legend.position = 'none', plot.title = element_text(size = 8, hjust = 0.5, face = "bold")) + scale_fill_viridis(discrete=TRUE, guide=FALSE) + coord_flip() 

plot1

```

<div style="text-align: justify">

Como se puede observar en el gráfico, la región de *East Asia & Pacific* es la que presenta un mayor crecimiento en la emisión de este gas invernadero en los últimos años. Para tener mayor claridad de esto, en la siguiente tabla se presenta el Top 2 de países con mayor emisión de co2 en cada región, dónde claramente se observa que China, Estados Unidos e India son los países que generan mayor contaminación a nivel mundial.

<div/>


```{r table1, warning = FALSE, message = FALSE, echo=FALSE, fig.width=8}

#Tabla Top 2 países más contaminantes

datdcastedtable1 <- datdcastedbarplot[datdcastedbarplot$year == 2014,]
datdcastedtable1 <- na.omit(datdcastedtable1)

extract.top <- function(x)
  tail(arrange(x, co2), 2)

top <- ddply(datdcastedtable1, .(region), extract.top)
top <- top[,c(3, 1,10)]


tabletop2 <- kable(top, col.names = c("Region", "Country", "CO2 Emissions (kt)"), align = "c") %>%
  kable_styling(full_width = T, font_size = 12) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  row_spec(0, bold = T, color = "white", background = "#168B8F") %>%
  row_spec(4, bold = T, color = "white", background = "#F76868") %>%
  row_spec(10, bold = T, color = "white", background = "#F7A368") %>%
  row_spec(12, bold = T, color = "white", background = "#F7CA68") %>%
  footnote(number = c("Source: World Bank"))
tabletop2
```


### 2.2 Energía Eléctrica Renovable

<div style="text-align: justify">

La *producción de energía eléctrica renovable* esta medida como el porcentaje de toda la producción de electricidad que es generada por plantas de energía renovables. El uso de este tipo de energía contribuye a que las casas sean mucho más autosuficientes en su consumo eléctrico. En un futuro no muy lejano, todos los edificios construidos deberán tener sus propias placas solares, calderas de biomasa o puntos de recarga para el coche eléctrico en su garaje comunitario; el autoconsumo eléctrico es mucho más fácil de alcanzar de lo que imaginamos.

Este es un paso importante frente a la constante lucha contra el cambio climático, y en el siguiente gráfico se puede observar cuáles son los países con mayor producción de este tipo de energía:

<div/>

``` {r plot2, warning = FALSE, message = FALSE, echo=FALSE, fig.width=8}

#     Bubble Chart
datdcastedbubble <- datdcasted
datdcastedbubble <- datdcastedbubble[datdcastedbubble$year == 2015,]


bubble <- datdcastedbubble %>%
  mutate(gdppc=round(gdppc,0)) %>%
  mutate(pop=round(pop/1000000,2)) %>%
  mutate(renew=round(renew,1)) %>%
  arrange(desc(pop)) %>%
  mutate(country = factor(country, country)) %>%
  mutate(text = paste("Country: ", country, "\nPopulation (M): ", pop, "\nRenewable electricity output: ", renew, "\nGdp per capita: ", gdppc, sep="")) %>%
  ggplot( aes(x=gdppc, y=renew, size = pop, color = region, text=text)) +
  geom_point(alpha=0.7) + scale_x_log10() +
  scale_size(range = c(1.4, 19), name="Population (M)") +
  scale_color_viridis(discrete=TRUE, guide=FALSE) +
  theme_classic() + labs(x='Log GDP per capita', y = 'Renewable electricity output (% of total electricity output)', title = 'Renewable electricity output by region', caption = 'Source: World Bank') +
  theme(plot.title = element_text(size = 8, hjust = 0.5, face = "bold"), legend.title = element_text(size = 7), legend.text = element_text(size = 6))

renewchart <- ggplotly(bubble, tooltip="text")
renewchart
```

<div style="text-align: justify">

En el gráfico, se contrasta la variable de interés con el PIB per cápita, que es el producto interno bruto dividido por la población a mitad de año. El PIB es la suma del valor agregado bruto de todos los productores residentes en la economía más todo impuesto a los productos, menos todo subsidio no incluido en el valor de los productos. Se calcula sin hacer deducciones por depreciación de bienes manufacturados o por agotamiento y degradación de recursos naturales. (Los datos se expresan en dólares de los Estados Unidos a precios constantes).

En primera instacia, se esperaría que sean los países más ricos los que tengan la posibilidad de contar con una mayor proporción de producción de energía renovable ya que son naciones con recursos económicos, sin embargo se observa como la mayoría de los países con altos porcentajes de energía renovable se encuentran del lado izquierdo del gráfico, es decir, dónde están los países con ingresos menores a los de la media mundial.

 <div/>  

### 2.3 Acceso a la electricidad 

<div style="text-align: justify">

La variable *acceso a la electricidad* es el porcentaje de población con acceso a la electricidad y estos datos se recopilan de la industria y encuestas nacionales. Está de más explicar cómo el acceso, y por ende consumo, a la electricidad afecta al medio ambiente; es por esto que a continuación se presenta la evolución de esta variable desde el año 2007 en las distintas regiones. A excepcion de América del Norte y Europa y Asia Central, quienes han tenido un 100% de acceso en todo el periodo de estudio, las demás regiones presentan una tendencia positiva.

Recomendación: pasar el mouse por encima del gráfico para obtener información específica de cada punto.
 
 <div/>  

```{r plot3, warning = FALSE, message = FALSE, echo=FALSE, fig.width=8}

#     Animmated Scatter


scatter <- datdcasted
scatter <- scatter[,c(1, 3, 4, 8)]

electricityplot <- ddply(scatter, .(region, year), summarize, meanelect = mean(electricity, na.rm = TRUE))


p <- ggplot(
  electricityplot,
  aes(year, meanelect, group = region, color = factor(region), 
      text = paste("Access to electricity (%): ", round(meanelect, 1),'  Year:', year, sep=''))) +
  geom_line(size = 2) + scale_color_viridis_d() + labs(x = "Year", y = "Access to electricity (% of population)", 
                                                       title = "Access to electricity by region: From 2007 to 2016", caption = "Source: World Bank") + 
  facet_wrap(region~.) + theme_ipsum() + theme(axis.text.x=element_blank(),
          axis.text.y=element_blank(), legend.position = "none", plot.title = element_text(size = 8, hjust = 0.5, face = "bold"), strip.text = element_text(color = "white", face = "bold"), strip.background = element_rect(color = "white", fill="#168B8F", size=1.5, linetype="solid"))


plot3 <- ggplotly(p, tooltip = "text")
plot3

```

